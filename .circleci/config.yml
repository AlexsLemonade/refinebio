version: 2
jobs:
  build:
    working_directory: /home/circleci/data_refinery
    machine: true
    pre:
      - run: echo "export COMMIT_MESSAGE=\"$(git log --format=oneline -n 1 $CIRCLE_SHA1)\"" >> ~/.bashrc
    steps:
      - run: curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
      - run: sudo apt-get install git-lfs
      - run: git lfs install
      - checkout

      # Setup Postgres in a Container
      - run: ./run_postgres.sh
      - run: sleep 30
      - run: ./common/install_db_docker.sh
      - run: sleep 30

      # Setup Nomad in a Container
      #- run: ./run_nomad.sh
      - run: ./run_nomad_docker.sh
      - run: sleep 30

      # Install our application
      - run: cd common && python setup.py sdist

      # Run Common Tests.
      - run: ./common/make_migrations.sh
      - run: ./common/run_tests.sh

      # Run Foreman Tests
      - run: ./foreman/run_tests.sh

      # Run Worker Tests
      - run: chmod -R a+rw workers/test_volume
      - run: 
            command: 
              echo $(git log --format=oneline -n 1 $CIRCLE_SHA1); if [[ $(git log --format=oneline -n 1 $CIRCLE_SHA1) = *"noslow"* ]]; then echo "Skipping slow tests.."; ./workers/run_tests.sh --exclude-tag=slow; else echo "Running all tests.."; ./workers/run_tests.sh; fi
            no_output_timeout: 36000
