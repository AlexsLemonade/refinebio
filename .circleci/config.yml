version: 2
jobs:
  build:
    working_directory: /home/circleci/data_refinery
    machine: true
    steps:
      - run: curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
      - run: sudo apt-get install git-lfs
      - run: git lfs install
      - checkout

      # Setup Postgres in a Container
      - run: ./run_postgres.sh
      - run: sleep 30
      - run: ./common/install_db_docker.sh
      - run: sleep 30
      - run: ./common/make_migrations.sh

      # Install our application
      - run: cd common && python setup.py sdist

      # Setup Nomad
      - run: ./run_nomad.sh

      # Run Common Tests.
      - run: ./common/run_tests.sh

      # Run Foreman Tests
      - run: ./foreman/run_tests.sh

      # Run Worker Tests
      - run: chmod -R a+rw workers/test_volume
      - run: ./workers/run_tests.sh