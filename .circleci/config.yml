version: 2
jobs:
  build:
    working_directory: /home/circleci/data_refinery
    machine: true
    # docker:
    #   - image: circleci/python:3.6
      # - image: circleci/postgres
      #   environment:
      #     POSTGRES_USER: data_refinery_user
      #     POSTGRES_DB: data_refinery
      #     POSTGRES_PASSWORD: data_refinery_password
      #     POSTGRES_HOST: 127.0.0.1
    steps:
      - checkout
      # - setup-remote-docker
      - run: sudo service postgresql stop && sudo apt-get remove -y
      - run: postgresql-9.4 && sudo apt-get update; sudo apt-get install -y
      - run: postgresql-9.3 postgresql-contrib-9.3
      - run: sudo sed -i "s/\port = 5433/port = 5432/"
      - run: /etc/postgresql/9.3/main/postgresql.conf
      - run: sudo cp /etc/postgresql/9.4/main/pg_hba.conf
      - run: /etc/postgresql/9.3/main/pg_hba.conf
      - run: sudo service postgresql restart
      - run: sudo -u postgres createuser ubuntu -d --superuser
      - run: createdb circle_test
      - run: createdb ubuntu
      - run: createdb data_refinery
      # - run: docker run --name postgres -d --env-file .circleci/postgres_env circleci/postgres
      # - run: sudo apt-get update && sudo apt-get install -f -y postgresql-client
      - run: ./.circleci/wait_for_postgres.sh
      # - run: sudo -u postgres ./data_models/install.sh
      # - run: docker ps
      # - run: docker network inspect bridge
      # - run: docker network ls
      # - run: docker container inspect $( docker ps | grep postgres | awk -F" "  '{print $NF}' )
      - run: ./data_models/run_tests.sh
      - run: ./foreman/run_tests.sh
      - run: ./common/run_tests.sh
      - run: ./workers/run_tests.sh
