version: '3'
services:
  message-queue:
    image: "rabbitmq:3"
  nginx:
    image: nginx
    volumes:
      - "$STATIC_DIRECTORY:/usr/share/nginx/html:ro"
    ports:
      - "80:80"
  workers:
    build:
      context: .
      dockerfile: workers/Dockerfile
    volumes:
      - "$VOLUME_DIRECTORY:/home/user/data_store"
    extra_hosts:
      - "database:$HOST_IP"
    depends_on:
      - message-queue
    links:
      - message-queue:rabbit
    env_file: workers/environments/test
  foreman:
    build:
      context: .
      dockerfile: foreman/Dockerfile
    volumes:
      - "$VOLUME_DIRECTORY:/home/user/data_store"
    extra_hosts:
      - "database:$HOST_IP"
    depends_on:
      - message-queue
      - workers
    links:
      - message-queue:rabbit
    env_file: foreman/environments/test
    command: test --keepdb --no-input data_refinery_foreman.surveyor.end_to_end_tests
    # command: "survey $EXPERIMENT_LIST"
